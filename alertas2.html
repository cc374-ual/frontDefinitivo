<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>File Editor</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">
  <link rel="stylesheet" href="styles.css">

</head>

<body>
  <nav>
    <div class="logo">
      <span>Suricata Web Config</span>
  </div>
    <a href="index.html">Inicio</a>
    <a href="alertas.html">Alertas</a>
    <a href="configuracion.html">Configuración</a>
    <a href="estado.html">Estado</a>
  </nav>

  <div id="contenedor-tabla">
    <div id="contenedor-filtros">
      <div id="filtros">
        <select id="filtro">
          <option value="alertDate">FechaAlerta</option>
          <option value="src_ip">IP origen</option>
          <option value="src_port">Puerto origen</option>
          <option value="dst_ip">IP destino</option>
          <option value="dst_port">Puerto destino</option>
          <option value="proto">Protocolo</option>
          <option value="signature_id">ID Alerta</option>
          <option value="signature">Descripción</option>
        </select>
        <input type="text" id="searchInput" placeholder="Buscar Alerta">
      </div>
      <div id="contenedor-fecha">
        <input type="text" id="fechaInicio" placeholder="Fecha de inicio">
        <input type="text" id="fechaFin" placeholder="Fecha de fin">
      </div>
      <button id="buscarBtn">Buscar</button>
    </div>
    <table id="tabla-alertas">
      <thead>
        <tr>
          <th>FechaAlerta</th>
          <th>IP origen</th>
          <th>Puerto origen</th>
          <th>IP destino</th>
          <th>Puerto destino</th>
          <th>Protocolo</th>
          <th>ID Alerta</th>
          <th>Descripción</th>
          <!-- Agrega más columnas según la estructura de tus datos -->
        </tr>
      </thead>
      <tbody id="tbody-alerts">
        <!-- Aquí se insertarán las filas de la tabla -->
      </tbody>
    </table>
    <div id="paginacion">
      <button id="anterior">Anterior</button>
      <button id="siguiente">Siguiente</button>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script>
    let filtroSeleccionado = "";
    let data;
    $(document).ready(function () {

      $.get('http://192.168.227.128:3000/alertas', function (response) {
        data = response;
        mostrarAlertas(data);
        actualizarBotones(data);
      });

      //var data;
      // Recibe los datos del endpoint
      let pagina = 1;
      const totalPagina = 10;
      console.log(filtroSeleccionado);

      function mostrarAlertas(data) {
        //if(filtroSeleccionado =="") {
        console.log(filtroSeleccionado);
        const inicio = (pagina - 1) * totalPagina;

        const fin = pagina * totalPagina;
        const alertasPagina = data.slice(inicio, fin);

        $('#tbody-alerts').empty();
        alertasPagina.forEach(function (alerta) {
          // Por cada alerta, crea una fila en la tabla
          $('#tbody-alerts').append(`
                  <tr>
                    <td>${alerta.alertDate}</td>
                    <td>${alerta.src_ip}</td>
                    <td>${alerta.src_port}</td>
                    <td>${alerta.dst_ip}</td>
                    <td>${alerta.dst_port}</td>
                    <td>${alerta.proto}</td>
                    <td>${alerta.signature_id}</td>
                    <td colspan='3'>${alerta.signature}</td>
                  </tr>
                `);
        });
        // }else {
        //   $('#tbody-alerts').empty();
        //   data.forEach(function(alerta) {
        //     // Por cada alerta, crea una fila en la tabla
        //     $('#tbody-alerts').append(`
        //       <tr>
        //         <td>${alerta.alertDate}</td>
        //         <td>${alerta.src_ip}</td>
        //         <td>${alerta.src_port}</td>
        //         <td>${alerta.dst_ip}</td>
        //         <td>${alerta.dst_port}</td>
        //         <td>${alerta.proto}</td>
        //         <td>${alerta.signature_id}</td>
        //         <td colspan='3'>${alerta.signature}</td>
        //       </tr>
        //     `);
        //   });
        // }
      }
      function actualizarBotones(data) {
        const totalPages = Math.ceil(data.length / totalPagina);
        $('#anterior').prop('disabled', pagina === 1);
        $('#siguiente').prop('disabled', pagina === totalPages || totalPages === 0);
      }

      function filtrarAlertas(searchTerm, filtro) {

        if (searchTerm === "" || filtro === "") {
          mostrarAlertas(data);
          actualizarBotones(data);
        }
        else {
          const alertasFiltradas = data.filter(function (alerta) {
            // Filtrar las alertas que coincidan con el término de búsqueda en cualquier campo
            // return (
            //     alerta.alertDate.toString() === searchTerm ||
            //     alerta.src_ip.toString() === searchTerm ||
            //     alerta.src_port.toString() === searchTerm ||
            //     alerta.dst_ip.toString() === searchTerm ||
            //     alerta.dst_port.toString() === searchTerm ||
            //     alerta.proto.toString().toLowerCase() === searchTerm ||
            //     alerta.signature_id.toString().toLowerCase() === searchTerm ||
            //     alerta.signature.toString().toLowerCase() === searchTerm
            // );
            return alerta[filtro].toString() === searchTerm.toString();
          });

          console.log(alertasFiltradas.length);
          // Mostrar las alertas filtradas en la tabla
          mostrarAlertas(alertasFiltradas);
          // Actualizar los botones de navegación
          actualizarBotones(alertasFiltradas);
        }
      }

      // $('#searchInput').on('input', function () {
      //   const searchTerm = $(this).val().trim().toLowerCase(); // Obtener el término de búsqueda
      //   filtrarAlertas(searchTerm, filtroSeleccionado); // Filtrar las alertas según el término de búsqueda
      // });

      $('#buscarBtn').click(function () {

        if(filtroSeleccionado === "alertDate"){
          const fechaInicio = $("#fechaInicio").datepicker("getDate");
          const fechaFin = $("#fechaFin").datepicker("getDate");
          filtrarAlertasPorFecha(fechaInicio, fechaFin);
        }else{
          const searchTerm = $('#searchInput').val().trim().toLowerCase();
          filtrarAlertas(searchTerm, filtroSeleccionado);
        }
      });

      $(document).ready(function () {
        // Inicializar el selector de fecha para el rango de fechas
        $("#fechaInicio").datepicker();
        $("#fechaFin").datepicker();
      });

      $('#anterior').click(function () {
        console.log(pagina);
        if (pagina > 1) {
          pagina--;
          filtrarAlertas($('#searchInput').val().trim().toLowerCase(), filtroSeleccionado);
          //mostrarAlertas(data);
          //actualizarBotones(data);
        }
      });

      $('#siguiente').click(function () {
        console.log(pagina);
        const totalPages = Math.ceil(data.length / totalPagina);
        console.log(data);
        console.log(totalPages);
        if (pagina < totalPages) {
          pagina++;
          filtrarAlertas($('#searchInput').val().trim().toLowerCase(), filtroSeleccionado);
          // mostrarAlertas(data);
          //actualizarBotones(data);
        }
        console.log("Que pasa");
      });

      $('#filtro').change(function () {
        filtroSeleccionado = $(this).val(); // Obtener el valor seleccionado del selector

        if (filtroSeleccionado === "alertDate") {
        $('#fechaInicio').show();
        $('#fechaFin').show();
        $('#searchInput').hide();
        $('#buscarBtn').show();
        // Inicializar los selectores de fecha para el rango de fechas
        $("#fechaInicio").datepicker();
        $("#fechaFin").datepicker();
    } else {
        // Si se selecciona otra opción, ocultar los campos de fecha y mostrar el campo de texto de búsqueda
        $('#fechaInicio').hide();
        $('#fechaFin').hide();
        $('#searchInput').show();
        $('#buscarBtn').show();
    }
      });


      function filtrarAlertasPorFecha(fechaInicio, fechaFin) {
        console.log(fechaFin);
        const alertasFiltradas2 = data.filter(function (alerta) {
          const alertDate = new Date(alerta.alertDate);
          return alertDate >= fechaInicio && alertDate <= fechaFin;
        });

        mostrarAlertas(alertasFiltradas2);
        actualizarBotones(alertasFiltradas2);
      }

      // $("#fechaInicio, #fechaFin").on("change", function () {
      //   const fechaInicio = $("#fechaInicio").datepicker("getDate");
      //   const fechaFin = $("#fechaFin").datepicker("getDate");
      //   filtrarAlertasPorFecha(fechaInicio, fechaFin);
      // });

    });


  </script>
</body>

</html>
